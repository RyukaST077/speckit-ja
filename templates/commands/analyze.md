---
description: タスク生成後に spec.md・plan.md・tasks.md 間の整合性と品質を非破壊で分析します。
scripts:
  sh: scripts/bash/check-prerequisites.sh --json --require-tasks --include-tasks
  ps: scripts/powershell/check-prerequisites.ps1 -Json -RequireTasks -IncludeTasks
---

## ユーザー入力

```text
$ARGUMENTS
```

入力がある場合は必ず考慮した上で処理を進めてください。

## 目的

実装開始前に、三つの主要成果物 (`spec.md`, `plan.md`, `tasks.md`) 間で発生している不整合、重複、曖昧さ、不十分な記述を特定します。このコマンドは `/tasks` が完全な `tasks.md` を生成した後にのみ実行してください。

## 運用上の制約

**厳格な読み取り専用**: ファイルを変更してはいけません。構造化された分析レポートのみを出力してください。改善案は任意で提案できますが、後続の編集コマンドはユーザーが明示的に承認した場合のみ実行されます。

**憲章の優先度**: プロジェクト憲章 (`/memory/constitution.md`) はこの分析範囲で絶対遵守です。憲章との衝突は自動的に CRITICAL と判定され、spec・plan・tasks の修正によって解消しなければなりません。原則そのものを変更する必要がある場合は、`/analyze` 以外で明示的な憲章更新手続きを行ってください。

## 実行手順

### 1. 分析コンテキストの初期化

リポジトリルートで `{SCRIPT}` を 1 度実行し、出力 JSON から FEATURE_DIR と AVAILABLE_DOCS を取得します。絶対パスを導出してください:

- SPEC = FEATURE_DIR/spec.md
- PLAN = FEATURE_DIR/plan.md
- TASKS = FEATURE_DIR/tasks.md

必須ファイルが欠けている場合はエラーメッセージとともに処理を中断し、不足している前提コマンドを実行するようユーザーに指示してください。
引数に "I'm Groot" のようなシングルクォートが含まれる場合は、'I'\''m Groot' のようにエスケープするか、可能であればダブルクォートで囲んでください ("I'm Groot")。

### 2. 成果物の読み込み (段階的開示)

各成果物から最小限の必要コンテキストのみを読み込みます:

**spec.md から:**

- 概要 / 背景
- 機能要件
- 非機能要件
- ユーザーストーリー
- エッジケース (存在する場合)

**plan.md から:**

- アーキテクチャ / スタックの選択
- データモデルの参照
- フェーズ構成
- 技術的制約

**tasks.md から:**

- タスク ID
- 説明文
- フェーズ分類
- 並列マーカー [P]
- 参照されるファイルパス

**憲章から:**

- `/memory/constitution.md` を読み込み、原則との整合性を検証する

### 3. セマンティックモデルの構築

内部表現を生成します (生の成果物をそのまま出力しないこと):

- **要件インベントリ**: 各機能・非機能要件に安定したキーを付与 (命令形のフレーズからスラッグを生成。例: "User can upload file" → `user-can-upload-file`)
- **ユーザーストーリー/アクションインベントリ**: 受け入れ条件を伴う離散的なユーザー行動を整理
- **タスクカバレッジマッピング**: 各タスクを 1 つ以上の要件またはストーリーに対してマッピング (キーワード・ID・主要語句で推定)
- **憲章ルールセット**: 原則名と MUST/SHOULD の規範的記述を抽出

### 4. 検出フェーズ (トークン効率重視)

シグナルの高い指摘に集中します。指摘件数は 50 件までとし、それ以上は概要に集約します。

#### A. 重複検出

- 類似する要件を特定
- 品質の低い表現を統合対象としてマーク

#### B. 曖昧さの検出

- 測定指標がない曖昧な形容詞 (fast, scalable, secure, intuitive, robust など) を警告
- 未解決プレースホルダー (TODO, TKTK, ???, `<placeholder>` など) を警告

#### C. 要件不足

- 動詞はあるが対象や測定可能な結果が欠落している要件
- 受け入れ条件と結び付いていないユーザーストーリー
- spec/plan に未定義のファイルやコンポーネントを参照するタスク

#### D. 憲章整合性

- MUST 原則と矛盾する要件や計画要素
- 憲章で義務付けられたセクションや品質ゲートの欠落

#### E. カバレッジギャップ

- 紐づくタスクが 0 件の要件
- 対応する要件/ストーリーがないタスク
- タスクに反映されていない非機能要件 (例: パフォーマンス、安全性)

#### F. 不整合

- 用語の揺れ (同じ概念がファイル間で異なる名称)
- plan に存在し spec にないデータエンティティ (またはその逆)
- 基盤整備前に統合タスクが現れるなど順序矛盾
- 相反する要件 (例: 一方が Next.js を要求し他方が Vue を指定)

### 5. 重大度の割り当て

以下の指針で優先度を決定します:

- **CRITICAL**: 憲章の MUST を違反、主要成果物の欠落、基礎機能を阻害するタスク未カバー要件
- **HIGH**: 重複/矛盾する要件、曖昧なセキュリティ・性能属性、テスト不能な受け入れ条件
- **MEDIUM**: 用語の揺れ、非機能要件のタスク欠如、詳細不足のエッジケース
- **LOW**: 文体・表現改善、実行順に影響しない軽微な冗長

### 6. コンパクトな分析レポートの作成

以下の構成で Markdown レポートを出力します (ファイルには書き込まないこと):

## Specification Analysis Report

| ID | カテゴリ | 重大度 | 場所 | 要約 | 推奨対応 |
|----|----------|--------|------|------|----------|
| A1 | Duplication | HIGH | spec.md:L120-134 | 類似する 2 つの要件 ... | 表現を統合し、明確な方を採用 |

(指摘ごとに 1 行追加し、カテゴリ頭文字を接頭辞とする安定 ID を生成)

**カバレッジサマリーテーブル:**

| 要件キー | タスク有無 | タスク ID | メモ |
|----------|------------|-----------|------|

**憲章整合性の問題:** (存在する場合)

**未対応タスク:** (存在する場合)

**メトリクス:**

- 要件総数
- タスク総数
- カバレッジ率 (1 件以上のタスクに紐づく要件の割合)
- 曖昧表現数
- 重複件数
- 重大 (CRITICAL) 問題数

### 7. 次のアクションを提示

レポート末尾に簡潔な Next Actions ブロックを出力します:

- CRITICAL がある場合: `/implement` の前に解消するよう推奨
- LOW/MEDIUM のみの場合: 進行は可能だが改善提案を提示
- 具体的なコマンド例を提示 (例: 「/specify で要件を再調整」「/plan でアーキテクチャ修正」「tasks.md を手動編集して 'performance-metrics' カバレッジ追加」)

### 8. 改善案の提示

ユーザーに「優先度の高い N 件について、具体的な修正案を提案しましょうか？」と確認します (自動で修正を適用してはいけません)。

## 運用原則

### コンテキスト効率

- **高シグナルを最小トークンで**: 行動可能な指摘に集中し、網羅的な羅列は避ける
- **段階的開示**: 成果物を段階的に読み込み、一括投入を避ける
- **トークン効率の高い出力**: 指摘表は最大 50 行まで。超過分はサマリーに集約
- **決定論的結果**: 変更がなければ再実行時も同じ ID と件数になること

### 分析ガイドライン

- **ファイルを変更しない** (読み取り専用分析)
- **存在しないセクションを捏造しない** (欠如している場合はその旨を報告)
- **憲章違反を最優先** (常に CRITICAL)
- **網羅的ルールより具体例を** (一般論ではなく具体的な事例を引用)
- **問題ゼロの場合も丁寧に報告** (カバレッジ統計を添えて成功レポートを出力)

## コンテキスト

{ARGS}
