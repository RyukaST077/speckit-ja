---
description: ユーザー要件に基づいて現在のフィーチャー向けのカスタムチェックリストを生成します。
scripts:
  sh: scripts/bash/check-prerequisites.sh --json
  ps: scripts/powershell/check-prerequisites.ps1 -Json
---

## チェックリストの目的: 「Unit Tests for English」

**重要な概念**: チェックリストとは要件記述の**単体テスト**です。特定ドメインにおける要件の品質・明確性・完全性を検証します。

**実装検証のためではありません**:
- ❌ 「ボタンが正しくクリックできるかを検証する」
- ❌ 「エラーハンドリングが機能するかをテストする」
- ❌ 「API が 200 を返すことを確認する」
- ❌ 実装やコードが仕様どおりかを検証すること

**要件品質を検証するためのものです**:
- ✅ 「すべてのカードタイプで視覚的な階層要件が定義されているか？」(完全性)
- ✅ 「『目立つ表示』が具体的なサイズや配置で定量化されているか？」(明確性)
- ✅ 「すべてのインタラクティブ要素でホバー状態の要件が一貫しているか？」(整合性)
- ✅ 「キーボード操作向けのアクセシビリティ要件が定義されているか？」(カバレッジ)
- ✅ 「ロゴ画像の読み込みに失敗した場合の挙動が仕様で定義されているか？」(エッジケース)

**比喩**: 仕様書が英語で書かれたコードだとすれば、チェックリストはその単体テストスイートです。実装が動くかではなく、要件が明確で完全かつ実装可能な状態にあるかを検証します。

## ユーザー入力

```text
$ARGUMENTS
```

入力がある場合は必ず考慮した上で処理を進めてください。

## 実行手順

1. **セットアップ**: リポジトリルートで `{SCRIPT}` を実行し、JSON から FEATURE_DIR と AVAILABLE_DOCS を取得します。
   - すべてのファイルパスは絶対パスに変換してください。
   - "I'm Groot" のようにシングルクォートを含む引数は `'I'\''m Groot'` のようにエスケープ (もしくは `"I'm Groot"` とダブルクォート) してください。

2. **意図の明確化 (動的)**: 最大 3 個までの文脈に応じた確認質問を生成します (定型のリストは禁止)。質問は以下を満たす必要があります:
   - ユーザーの表現 + spec/plan/tasks から抽出したシグナルに基づいて生成する
   - チェックリスト内容に実質的影響を与える情報のみを尋ねる
   - `$ARGUMENTS` で明確な点は質問をスキップする
   - 幅広さより精度を優先する

   生成アルゴリズム:
   1. シグナル抽出: ドメインキーワード (auth, latency, UX, API など)、リスク指標 ("critical", "must", "compliance")、ステークホルダー示唆 ("QA", "review", "security team")、明示的な成果物 ("a11y", "rollback", "contracts")。
   2. シグナルを最大 4 つの候補フォーカス領域にクラスタ化し、関連性順に並べる。
   3. 明示されていない場合は想定利用者とタイミング (著者、自動レビュー、QA、リリースなど) を推定。
   4. 欠けている次元 (スコープ範囲、深度/厳格さ、リスク強調、除外境界、測定可能な受入基準) を特定。
   5. 以下のアーキタイプを参考に質問を組み立てる:
      - スコープ精査 (例: 「X と Y との統合ポイントを含めますか？それともローカルモジュールの正しさに限定しますか？」)
      - リスク優先度 (例: 「どのリスク領域を必須チェックとして扱いますか？」)
      - 深度調整 (例: 「これは軽量な事前確認リストですか、それとも正式なリリースゲートですか？」)
      - 想定利用者 (例: 「このリストは著者のみが使いますか？それとも PR レビュー時に同僚も使いますか？」)
      - 境界設定 (例: 「今回はパフォーマンス調整項目を明示的に除外しますか？」)
      - シナリオ不足 (例: 「リカバリーフローが見当たりません。ロールバック/部分失敗パスは対象ですか？」)

   質問フォーマットのルール:
   - 選択肢を提示する場合は `Option | 候補 | 重要性` の 3 列テーブルを用いる
   - 選択肢は最大 A〜E まで。自由回答が明確な場合はテーブルを省略
   - 既に述べられた内容をユーザーに繰り返させない
   - 推測によるカテゴリは避ける (不明な点は「X がスコープに含まれるか確認してください」と明示)

   対話ができない場合の既定値:
   - 深度: 標準
   - 利用者: コード関連ならレビュアー (PR)、それ以外は著者
   - フォーカス: 関連度上位 2 つのクラスタ

   質問は Q1/Q2/Q3 とラベル付けして提示します。回答後、シナリオ種別 (代替 / 例外 / リカバリー / 非機能領域) が 2 つ以上不明確なままなら、最大 2 つまで追加のフォローアップ質問 (Q4/Q5) を行ってもよいですが、必ず 1 行の根拠を添えてください (例: 「リカバリーパスのリスクが未解決」)。質問総数は 5 以内とし、ユーザーが追加を拒否した場合は中断します。

3. **ユーザー要望の理解**: `$ARGUMENTS` と確認回答を統合して以下を決定します:
   - チェックリストのテーマ (例: security, review, deploy, ux)
   - ユーザーが明示した必須項目の整理
   - 選択したフォーカスをカテゴリ構造にマッピング
   - spec/plan/tasks から不足文脈を補いつつも捏造しない

4. **フィーチャーコンテキストの読み込み**: FEATURE_DIR から次を参照します:
   - spec.md: フィーチャー要件とスコープ
   - plan.md (存在すれば): 技術詳細と依存関係
   - tasks.md (存在すれば): 実装タスク
   
   **コンテキスト読み込み方針**:
   - 対象フォーカスに関連する最小限のみ取り込む (全量読み込みを避ける)
   - 長文セクションは簡潔なシナリオ/要件の要約に変換する
   - 実装詳細や無関係な情報は含めない
   - チェックリストに関係しないセクションは読み飛ばす

5. **チェックリスト作成**:
   - 各フォーカス領域をカテゴリに展開し、カテゴリ内の項目は `- [ ] CHK### ...` 形式で連番付け (CHK001 から開始)
   - 各項目は次の条件を満たすこと:
     - 要件の品質 (明瞭性、完全性、一貫性、測定可能性、範囲) を検証する質問である
     - 参照元のドキュメントとリンク (例: `[Clarity, Spec §FR-1]`) を角括弧で添える
     - 具体的で判定可能、曖昧な形容詞で終わらない
   - 1 カテゴリあたり 3〜8 項目を推奨 (最大 12 項目)
   - 重要度の高い領域は最初のカテゴリに配置
   - 検出されたリスク/ギャップに対する検証項目を必ず含める
   - テストや実装を指示する表現は禁止 (要件品質に限定)

   **許容される表現パターン**:
   - 「[要件種別] が [シナリオ] について具体的に定義されていますか？」
   - 「[曖昧な用語] は測定可能な基準で明確化されていますか？」
   - 「[セクション A] と [セクション B] の要件に矛盾はありませんか？」
   - 「[要件] は客観的に検証できますか？」
   - 「[エッジケース/シナリオ] に対する要件が欠けていませんか？」
   - 「仕様は [不足している観点] を定義していますか？」

   **禁止される表現パターン**:
   - 「ボタンがクリックで動作するか確認する」など実装検証
   - 「API が 200 を返すかテストする」など挙動確認
   - 「テストを実装する」など作業指示

6. **構造の参照**: `templates/checklist-template.md` の構造 (タイトル、メタ情報、カテゴリ見出し、ID 形式) を踏襲してください。テンプレートが利用できない場合は、H1 タイトル、目的/作成日/フィーチャーのメタ行、`##` 見出し + `- [ ] CHK###` 形式を用います。

7. **レポート**: 作成したチェックリストのパス、項目数を出力し、各実行で新しいファイルが生成される旨を伝えます。併せて以下をまとめます:
   - 選択したフォーカス領域
   - 深度レベル
   - 想定利用者/タイミング
   - ユーザーが指定した必須項目がどのように反映されたか

**重要事項**: `/speckit.checklist` コマンドは毎回短く分かりやすい名前のチェックリストファイルを作成します (既存の同名ファイルがある場合を除く)。これにより:

- 用途の違う複数のチェックリスト (例: `ux.md`, `test.md`, `security.md`) を作成できる
- 用途がわかるファイル名で整理しやすい
- `checklists/` フォルダ内で簡単に見つけられる

不要になったチェックリストは適宜整理してください。

## チェックリスト種別とサンプル項目

**UX 要件品質**: `ux.md`

サンプル項目 (要件品質の検証であり実装確認ではない):
- 「視覚的なヒエラルキー要件は測定可能な基準で定義されていますか？ [明確性, Spec §FR-1]」
- 「UI 要素の数と配置は明示されていますか？ [完全性, Spec §FR-1]」
- 「ホバー/フォーカス/アクティブ状態の要件は一貫していますか？ [整合性, Spec §FR-3]」
- 「すべてのインタラクティブ要素にアクセシビリティ要件が定義されていますか？ [カバレッジ]」
- 「画像読み込み失敗時のフォールバック挙動は定義されていますか？ [エッジケース]」
- 「『視覚的に目立つ』要件は客観的に測定できますか？ [測定可能性, Spec §FR-1]」

**API 要件品質**: `api.md`

サンプル項目:
- 「あらゆる失敗シナリオに対してエラーレスポンス形式が定義されていますか？ [完全性]」
- 「レート制限要件は具体的な閾値で定量化されていますか？ [明確性]」
- 「すべてのエンドポイントで認証要件が一貫していますか？ [整合性]」
- 「外部依存先に対するリトライ/タイムアウト要件が定義されていますか？ [カバレッジ]」
- 「バージョニング戦略は文書化されていますか？ [不足項目]」

**パフォーマンス要件品質**: `performance.md`

サンプル項目:
- 「パフォーマンス要件は具体的な指標で定義されていますか？ [明確性]」
- 「クリティカルなユーザージャーニーごとの性能目標が設定されていますか？ [カバレッジ]」
- 「異なる負荷条件下での要件が定義されていますか？ [完全性]」
- 「パフォーマンス要件は客観的に測定できますか？ [測定可能性]」
- 「高負荷時の劣化要件は定義されていますか？ [エッジケース, 不足項目]」

**セキュリティ要件品質**: `security.md`

サンプル項目:
- 「すべての保護対象リソースで認証要件が定義されていますか？ [カバレッジ]」
- 「機密情報に対するデータ保護要件が定義されていますか？ [完全性]」
- 「脅威モデルが文書化され、それに沿った要件が策定されていますか？ [トレーサビリティ]」
- 「セキュリティ要件はコンプライアンス義務と整合していますか？ [整合性]」
- 「セキュリティ侵害/障害発生時の対応要件が定義されていますか？ [不足項目, 例外フロー]」

## アンチパターン: 行ってはいけないこと

**❌ 誤った例 – これらは実装のテストであり、要件品質の検証ではありません:**

```markdown
- [ ] CHK001 - ランディングページに 3 件のエピソードカードが表示されることを確認する [Spec §FR-001]
- [ ] CHK002 - デスクトップでホバー状態が正しく動作することをテストする [Spec §FR-003]
- [ ] CHK003 - ロゴをクリックするとホームに移動することを確認する [Spec §FR-010]
- [ ] CHK004 - 関連エピソードセクションに 3〜5 件表示されることを確認する [Spec §FR-005]
```

**✅ 正しい例 – これらは要件の品質をテストしています:**

```markdown
- [ ] CHK001 - 注目コンテンツの数とレイアウトは明示的に定義されていますか？ [完全性, Spec §FR-001]
- [ ] CHK002 - すべてのインタラクティブ要素でホバー状態の要件が一貫していますか？ [整合性, Spec §FR-003]
- [ ] CHK003 - ブランド要素のナビゲーション要件は明確ですか？ [明確性, Spec §FR-010]
- [ ] CHK004 - 関連エピソードの選定基準は文書化されていますか？ [不足項目, Spec §FR-005]
- [ ] CHK005 - 非同期データ読み込み時のローディング状態要件は定義されていますか？ [不足項目]
- [ ] CHK006 - 「視覚的なヒエラルキー」要件は客観的に測定できますか？ [測定可能性, Spec §FR-001]
```

**主な違い**:
- 誤り: システムが X を行うかを検証している
- 正しい: X が明確に仕様化されているかを検証している
- 誤り: 挙動の確認
- 正しい: 要件の品質検証
- 誤り: 「X をしますか？」
- 正しい: 「X が明確に仕様化されていますか？」
