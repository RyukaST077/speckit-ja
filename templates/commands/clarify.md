---
description: 現在のフィーチャー仕様の不足箇所を抽出し、最大 5 件の高精度な確認質問を行い、その回答を仕様へ反映します。
scripts:
   sh: scripts/bash/check-prerequisites.sh --json --paths-only
   ps: scripts/powershell/check-prerequisites.ps1 -Json -PathsOnly
---

## ユーザー入力

```text
$ARGUMENTS
```

入力がある場合は必ず考慮した上で処理を進めてください。

## アウトライン

目的: アクティブなフィーチャー仕様の曖昧さや未決定事項を検出し、質問を通じて明確化した内容を仕様ファイルへ記録します。

注意: この明確化ワークフローは `/speckit.plan` を実行する前 (かつ完了させた状態) であることが期待されています。ユーザーが明示的にスキップを宣言した場合 (例: 調査スパイク) は継続可能ですが、その場合は後続作業での手戻りリスク増大を警告してください。

実行手順:

1. リポジトリルートで `{SCRIPT}` を 1 度実行し、結合モード (`--json --paths-only` / `-Json -PathsOnly`) の JSON から以下を取得します:
   - `FEATURE_DIR`
   - `FEATURE_SPEC`
   - (必要に応じて `IMPL_PLAN`, `TASKS` を後続フロー用に保持)
   - JSON 解析に失敗した場合は処理を中断し、ユーザーへ `/speckit.specify` の再実行またはフィーチャーブランチ環境の確認を案内します。
   - "I'm Groot" のようにシングルクォートを含む引数は `'I'\''m Groot'` のようにエスケープするか、可能であれば `"I'm Groot"` とダブルクォートで記述してください。

2. 現在の spec ファイルを読み込み、以下の分類で構造化された曖昧さ/カバレッジスキャンを実施します。各カテゴリの状態を Clear / Partial / Missing のいずれかでマーキングし、内部カバレッジマッピングを作成します (質問が不要な場合を除き、マップは出力しません)。

   機能スコープと挙動:
   - ユーザーの主要目的と成功基準
   - 明確に除外された範囲
   - ユーザーロール / ペルソナの差異

   ドメイン & データモデル:
   - エンティティ、属性、リレーション
   - 識別性/一意制ルール
   - ライフサイクル / 状態遷移
   - データ量 / スケール前提

   インタラクション & UX フロー:
   - 重要なユーザージャーニー / シーケンス
   - エラー・空・ローディング状態
   - アクセシビリティ / ローカライズ要件

   非機能品質属性:
   - パフォーマンス (レイテンシ・スループット目標)
   - スケーラビリティ (水平/垂直、制限値)
   - 信頼性・可用性 (稼働率、復旧期待)
   - 可観測性 (ログ、メトリクス、トレース指標)
   - セキュリティ・プライバシー (認証/認可、データ保護、脅威前提)
   - コンプライアンス / 規制制約 (該当する場合)

   連携 & 外部依存:
   - 外部サービス/API とその失敗モード
   - データの入出力形式
   - プロトコル/バージョン前提

   エッジケース & 障害対応:
   - ネガティブシナリオ
   - レート制限 / スロットリング
   - コンフリクト解決 (同時編集など)

   制約 & トレードオフ:
   - 技術的制約 (言語、ストレージ、ホスティング)
   - 明示されたトレードオフや却下済み代替案

   用語と一貫性:
   - グロッサリーに相当する共通語
   - 避けるべき同義語や非推奨語

   完了シグナル:
   - 受け入れ基準のテスト可能性
   - 測定可能な Done 定義

   その他 / プレースホルダー:
   - TODO マーカー / 未決定事項
   - 「堅牢」「直感的」のような曖昧な形容詞 (測定基準が未定義)

   Partial / Missing のカテゴリには候補質問を割り当てます。ただし以下の場合は除外します:
   - 明確化しても実装/検証戦略が変わらない
   - プランニング段階で扱う方が適切 (内部的にメモ)

3. 候補質問の優先度付きキューを最大 5 件まで生成します (すべて出力しないこと)。制約:
   - セッション全体で質問は最大 10 件まで
   - 各質問は次のいずれかで回答可能にする:
     * 2〜5 個の排他的選択肢 (選択肢は Compact Table: `Option | 候補 | 重要理由`)
     * 1 語または短文で回答できる形式 (「5 語以内で回答」など明示)
   - 以下の場合のみ質問に含める:
     * アーキテクチャ、データモデリング、タスク分解、テスト計画、UX 挙動、運用準備、コンプライアンス検証に実質影響がある
   - 既に回答済み / 些末 / 実装計画レベルの詳細は除外
   - 高影響なカテゴリから優先 (Impact × Uncertainty が高いもの)

4. 質問の逐次ループ:
   - 1 回につき 1 問のみ提示
   - 選択式の場合:
     * すべての選択肢を分析し、プロジェクトにとって最適な選択肢を明示 (推奨理由付き)
   - ユーザーが選択肢を指定する前に推奨を伝える (ユーザーの判断の参考にする)
   - ユーザーが選択/回答したら、その内容を確認。曖昧な場合は 1 回だけ再確認可
   - Qx という形式で質問と回答を記録
   - ユーザーが「done」「stop」等を発した場合は即座に終了
   - 質問数が 5 に達したら終了
   - 今後の質問を先出ししない
   - 有効な質問が存在しない場合は、「重大な曖昧さは検出されませんでした」と報告して終了

5. 各回答を受け取ったら即座に以下を実施:
   - セッションで初めての回答の場合:
     * 仕様内に `## Clarifications` セクションが存在するか確認。なければ最上位のコンテキストセクション直下に作成
     * 本日の日付で `### Session YYYY-MM-DD` 見出しを追加 (存在しなければ)
   - その直下に `- Q: <質問> → A: <最終回答>` を追記
   - 回答内容を仕様の適切なセクションへ反映:
     * 機能的な曖昧さ → 機能要件へ追記または更新
     * ユーザー/役割の区別 → ユーザーストーリーまたは Actors セクションを更新
     * データ形状/エンティティ → data model の項目を追加/更新 (順序を維持)
     * 非機能制約 → 非機能/品質セクションへ測定可能な形で追記
     * エッジケース/異常系 → Edge Cases / Error Handling へ追記 (必要なら新規作成)
     * 用語整合 → 仕様全体で用語を統一 (必要なら一度だけ「(旧称: X)」を併記)
   - 回答によって古い曖昧表現が無効になった場合は削除または置換し、矛盾を残さない
   - 各書き込み後に仕様を保存 (原子的に上書き)
   - 見出し階層は維持し、無関係なセクション順序を変えない
   - 追加する記述は最小限かつテスト可能な粒度に留める

6. 検証 (各書き込み後と最終終了時):
   - Clarifications セクションには各回答につき 1 行のみ存在すること
   - 質問数 (受理済み) が 5 件以下であること
   - 回答で解消したはずの曖昧表現が残っていないかチェック
   - 矛盾する記述が残っていないか確認
   - Markdown 構造が正しいか検証。追加する見出しは `## Clarifications` と `### Session YYYY-MM-DD` のみ
   - 用語の一貫性を確認 (仕様全体で統一されていること)

7. 更新した仕様を `FEATURE_SPEC` に書き戻します。

8. セッション完了時 (または途中終了時) の報告:
   - 質問実施数と回答数
   - 更新した仕様ファイルのパス
   - 変更したセクション一覧
   - 上記分類ごとのカバレッジサマリーテーブル (Status: Resolved / Deferred / Clear / Outstanding)
   - Deferred/Outstanding がある場合は `/speckit.plan` へ進むべきか、後日 `/speckit.clarify` を再実行すべきか推奨
   - 推奨する次のコマンドを提示

挙動ルール:
- 重大な曖昧さが見つからない場合は「重大な曖昧さは検出されませんでした」と返し、次の手順を提案
- spec ファイルが存在しない場合は `/speckit.specify` の実行を案内 (ここで新規作成しない)
- 質問は最大 5 件 (再質問はカウントしない)
- 推測によるスタック質問は避ける。欠如が実装の正確さを阻害する場合のみ質問
- ユーザーが中断を明示した場合は即停止
- 質問を行わない場合もカバレッジサマリーテーブルを提供
- 質問枠を使い切っても高影響カテゴリが未解決なら、Deferred として明示し理由を記す

優先順位付けのためのコンテキスト: {ARGS}
